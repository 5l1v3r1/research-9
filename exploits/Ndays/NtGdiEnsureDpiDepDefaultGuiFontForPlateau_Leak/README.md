### NtGdiEnsureDpiDepDefaultGuiFontForPlateau Information Leak

### CVE ID
Unknown (Silently Patched)

### CVSSv3 Score
[3.3](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N)

### Blog Post
TBA

### Author
Grant Willcox of VerSprite Labs Research Team
([@tekwizz123](https://twitter.com/tekwizz123))

### Exploit explanation
A information leak exists within **NtGdiEnsureDpiDepDefaultGuiFontForPlateau** on Windows 10 v1709 and later which have not applied the November 2019 cumulative update. The information leak exists because Microsoft forgot to set the return value to 0 after calling **GreEnsureDpiDepDefaultGuiFontForPlateau** from within **NtGdiEnsureDpiDepDefaultGuiFontForPlateau**. Exploitation of this vulnerability allows attackers to leak the value of **win32kbase!gahDpiDepDefaultGuiFonts**, which they can then use to determine the base address of **win32kbase.sys** and bypass KASLR.

The provided exploit has been tested against Windows 10 x64 version 1903 with **win32kfull.sys** version 10.0.18362.449 (October 2019 patches applied). The exploit was compiled using Visual Studio Community 2019 with a new console project. Other systems have not been tested.

### Portabilty Notes
The offset of 0x215A20 between **win32kbase.sys** to **win32kbase!gahDpiDepDefaultGuiFonts** is specific to **win32kbase.sys** version 10.0.18362.449. If you wish to target a different **win32kbase.sys** version you will need to update this offset for the corresponding **win32kbase.sys** file version you are targeting. It is possible to find this offset automatically however doing so would likely involve adding code to parsing the PE file of **win32kbase.sys**.
